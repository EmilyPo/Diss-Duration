# Age {#age}

This section explores exponentially distributed models that include age dynamics.  

Age dyanmics are particularly important for models of STIs due to the differences in reported diagnoses by age categories. Therefore it is important to represent relationships in these age cats reasonably, as duration and formation influence risk. 

__Age’s effects on relationship duration are complex__  
 - Relationship age at time of interview usually lower for younger people, but due to a combination of ‘churn’ and not being alive long enough to have had decades-long relationships. 
 - Age difference between ego and alter matters, but affect of age difference is likely to vary across the life course. 
 - The effect age of age difference on relationship duration may be different depending on if the male or female is the older partner. 
 - Which age is most important for relationship persistence? Age at beginning of relationship, or current age? 
 - Whose age to model? Ego age? Partner age? Ego age and age difference? 

__Dyadic Complications__  
 - Relationship duration is unlikely to be independent of other relationships each partner may be participating in. 
 - Is there a way to represent this in a parametric regression model, and if not, what are the consequences of assuming independence between relationships? 

Likely other complications. 

## Full Dataset 

### Kaplan-Meier Visuals  

As we see later in this document, models that use current ego age versus those that use initial ego age differ little. Both versions of age are conceptually interesting, but graphs below show by initial age is complicated to understand in this dataset given how the data was collected. 

I think that initial age at rel formation would be more useful for dissolution model in ERGMS b/c you wouldn't have to keep re-calculating dissolution probability when nodes age

```{r km-cats, echo=FALSE}
# unweighted w/ covs
km_agecat_initial <- readRDS(here("model_fits", "km", "km-agecat-initial.rds"))
km_agecat_current <- readRDS(here("model_fits", "km", "km-agecat-current.rds"))

# weighted, with & w/o covs
km_weighted <- readRDS(here("model_fits",  "km", "km-weighted.rds"))
km_agecat_weighted <- readRDS(here("model_fits",  "km", "km_ac_weighted.rds"))
km_i_agecat_weighted <- readRDS(here("model_fits", "km", "km_i_agecat_weighted.rds"))

Survs <- as.data.frame(cbind(km_weighted$surv, km$surv, c(0:363)))
colnames(Survs) <- c("KMW", "KM", "t")

plot_ly(Survs, x = ~t/12, y = ~KM, name = "Kalplan-Meier", mode = "lines", type = "scatter") %>%
  add_trace(y = ~KMW, mode = "lines", name = "Weighted Kaplan-Meier",
            line = list(color="darkred")) %>%
  layout(title="Kaplan-Meier Comparison",  
         yaxis = list(title = "S(t)"),
         xaxis = list (title = "t, years"))

autoplot(km_agecat_weighted, censor=FALSE, conf.int=FALSE,
     main="K-M Survival Curves by Current AgeCat",
     ylab="S(t)", xlab="t, months")

autoplot(km_i_agecat_weighted, censor=F,
     main="Weighted K-M Survival Curves by Initial AgeCat",
     ylab="S(t)", xlab="months")

```

### Mixed Exp Models by Current AgeCat  

Mixture model across whole pop does pretty well but overestimates duration of young rels and underestmates duration of long rels. Let's see if we can do better when each age cat is its own mixture model (2 lambdas and a mixture weight). 

Here I fit 2-component mixture models to each of the age categories and plot them as separate lines. 

Would also like to do this by initial age cat, but haven't done so yet. 

__THESE MODELS WERE NOT FITTED USING NSFG SURVEY WEIGHTS__

```{r mixed-exp-ea, echo=FALSE}

# out.width='50%'

##### load models #######
mix1519 <- readRDS(here("model_fits", "mixed", "mix1519.rds"))
mix2024 <- readRDS(here("model_fits", "mixed", "mix2024.rds"))
mix2529 <- readRDS(here("model_fits", "mixed", "mix2529.rds"))
mix3034 <- readRDS(here("model_fits", "mixed", "mix3034.rds"))
mix3539 <- readRDS(here("model_fits", "mixed", "mix3539.rds"))
mix4044 <- readRDS(here("model_fits", "mixed", "mix4044.rds"))

# inverse logit function
logit = function(p){
  log(p/(1-p))
}

invLogit = function(phi){
  1/(1+exp(-phi))
}

###### plot using plotly #######
durVec <- 0:363

# made data frame of mixed exp outputs
df <- as.data.frame(cbind(durVec, 
            invLogit(coef(mix1519)[3]) * pexp(q = durVec, exp(coef(mix1519)[1]), lower.tail = FALSE) +
        (1-invLogit(coef(mix1519)[3])) * pexp(q = durVec, exp(coef(mix1519)[2]), lower.tail = FALSE),
            invLogit(coef(mix2024)[3]) * pexp(q = durVec, exp(coef(mix2024)[1]), lower.tail = FALSE) +
        (1-invLogit(coef(mix2024)[3])) * pexp(q = durVec, exp(coef(mix2024)[2]), lower.tail = FALSE), 
            invLogit(coef(mix2529)[3]) * pexp(q = durVec, exp(coef(mix2529)[1]), lower.tail = FALSE) +
        (1-invLogit(coef(mix2529)[3])) * pexp(q = durVec, exp(coef(mix2529)[2]), lower.tail = FALSE),
            invLogit(coef(mix3034)[3]) * pexp(q = durVec, exp(coef(mix3034)[1]), lower.tail = FALSE) +
        (1-invLogit(coef(mix3034)[3])) * pexp(q = durVec, exp(coef(mix3034)[2]), lower.tail = FALSE),
            invLogit(coef(mix3539)[3]) * pexp(q = durVec, exp(coef(mix3539)[1]), lower.tail = FALSE) +
        (1-invLogit(coef(mix3539)[3])) * pexp(q = durVec, exp(coef(mix3539)[2]), lower.tail = FALSE),
            invLogit(coef(mix4044)[3]) * pexp(q = durVec, exp(coef(mix4044)[1]), lower.tail = FALSE) +
        (1-invLogit(coef(mix4044)[3])) * pexp(q = durVec, exp(coef(mix4044)[2]), lower.tail = FALSE)))
colnames(df) <- c("t", "15-19", "20-24", "25-29", "30-34", "35-39", "40-44")


## using plotly 
plot_ly(df, x = ~t/12, y = ~`15-19`, type='scatter', mode='lines', name="15-19") %>%
  add_trace(y = ~`20-24`, mode = 'lines', name = "20-24") %>%
  add_trace(y = ~`25-29`, mode = 'lines', name = "25-29") %>%
  add_trace(y = ~`30-34`, mode = 'lines', name = "30-34") %>%
  add_trace(y = ~`35-39`, mode = 'lines', name = "35-39") %>%
  add_trace(y = ~`40-44`, mode = 'lines', name = "40-44") %>%
  layout(title = "Surival by AgeCat, Mixed Exponential",
         yaxis = list(title = "S(t)"),
         xaxis = list (title = "t, years"))

# weighted average model results 
p <- dat %>% count(e.agecat) %>% mutate(prop = n/sum(n))

df$w15 <- as.numeric(rep(p[1,3], length(df$t)))
df$w20 <- as.numeric(rep(p[2,3], length(df$t)))
df$w25 <- as.numeric(rep(p[3,3], length(df$t)))
df$w30 <- as.numeric(rep(p[4,3], length(df$t)))
df$w35 <- as.numeric(rep(p[5,3], length(df$t)))
df$w40 <- as.numeric(rep(p[6,3], length(df$t)))

avg <- df$`15-19`*df$w15 + df$`20-24`*df$w20 + df$`25-29`*df$w25 + 
       df$`30-34`*df$w30 + df$`35-39`*df$w35 + df$`40-44`*df$w40

# compare avg to survival 
df2 <- as.data.frame(cbind(1:364, km$surv, avg)) 
colnames(df2) <- c("t", "KM", "MixedExpAvg")

plot_ly(df2, x = ~t/12, y = ~KM, mode = 'lines', name = "K-M, unweighted", type='scatter') %>%
  add_trace(y = ~MixedExpAvg, mode = 'lines', name = "Mixed Exp") %>%
  layout(title="K-M versus Weighted Average of Mixed Exp Models (no survey weights)",
         yaxis = list(title="S(t)"), 
         xaxis= list("t, years"))

```


```{r mixexp-table, echo=FALSE}
rate15_1 <- (1/exp(coef(mix1519)[1]))/12
rate15_2 <- (1/exp(coef(mix1519)[2]))/12
weight15 <- invLogit(coef(mix1519)[3])

rate20_1 <- (1/exp(coef(mix2024)[1]))/12
rate20_2 <- (1/exp(coef(mix2024)[2]))/12
weight20 <- invLogit(coef(mix2024)[3])

rate25_1 <- (1/exp(coef(mix2529)[1]))/12
rate25_2 <- (1/exp(coef(mix2529)[2]))/12
weight25 <- invLogit(coef(mix2529)[3])

rate30_1 <- (1/exp(coef(mix3034)[1]))/12
rate30_2 <- (1/exp(coef(mix3034)[2]))/12
weight30 <- invLogit(coef(mix3034)[3])

rate35_1 <- (1/exp(coef(mix3539)[1]))/12
rate35_2 <- (1/exp(coef(mix3539)[2]))/12
weight35 <- invLogit(coef(mix3539)[3])

rate40_1 <- (1/exp(coef(mix4044)[1]))/12
rate40_2 <- (1/exp(coef(mix4044)[2]))/12
weight40 <- invLogit(coef(mix4044)[3])
```


Age Category | Short Dur | Long Dur | Prop. Short  
---------- | -----------|----------|-------------
15-19 | `r round(rate15_1,2)` | `r round(rate15_2,2)` | `r round(weight15,2)`
20-24 | `r round(rate20_1,2)` | `r round(rate20_2,2)` | `r round(weight20,2)`
25-29 | `r round(rate25_1,2)` | `r round(rate25_2,2)` | `r round(weight25,2)`
30-34 | `r round(rate30_1,2)` | `r round(rate30_2,2)` | `r round(weight30,2)`
35-39 | `r round(rate35_1,2)` | `r round(rate35_2,2)` | `r round(weight35,2)`
40-44 | `r round(rate40_1,2)` | `r round(rate40_2,2)` | `r round(weight40,2)`

```{r mixExpWeights, echo=FALSE}

weightsMixExp <- readRDS(here("model_fits", "mixed", "weightsMixExp.rds"))

shortDur <- 1/exp(coef(weightsMixExp)[1])
longDur <- 1/exp(coef(weightsMixExp)[2])
wmix15 <- invLogit(coef(weightsMixExp)[3])
wmix20 <- invLogit(coef(weightsMixExp)[4])
wmix25 <- invLogit(coef(weightsMixExp)[5])
wmix30 <- invLogit(coef(weightsMixExp)[6])
wmix35 <- invLogit(coef(weightsMixExp)[7])
wmix40 <- invLogit(coef(weightsMixExp)[8])

dfw <- as.data.frame(cbind(durVec, 
            wmix15 * pexp(q = durVec, exp(coef(weightsMixExp)[1]), lower.tail = FALSE) +
        (1-wmix15) * pexp(q = durVec, exp(coef(weightsMixExp)[2]), lower.tail = FALSE),
            wmix20 * pexp(q = durVec, exp(coef(weightsMixExp)[1]), lower.tail = FALSE) +
        (1-wmix20) * pexp(q = durVec, exp(coef(weightsMixExp)[2]), lower.tail = FALSE), 
            wmix25 * pexp(q = durVec, exp(coef(weightsMixExp)[1]), lower.tail = FALSE) +
        (1-wmix25) * pexp(q = durVec, exp(coef(weightsMixExp)[2]), lower.tail = FALSE),
            wmix30 * pexp(q = durVec, exp(coef(weightsMixExp)[1]), lower.tail = FALSE) +
        (1-wmix30) * pexp(q = durVec, exp(coef(weightsMixExp)[2]), lower.tail = FALSE),
            wmix35 * pexp(q = durVec, exp(coef(weightsMixExp)[1]), lower.tail = FALSE) +
        (1-wmix35) * pexp(q = durVec, exp(coef(weightsMixExp)[2]), lower.tail = FALSE),
            wmix40 * pexp(q = durVec, exp(coef(weightsMixExp)[1]), lower.tail = FALSE) +
        (1-wmix40) * pexp(q = durVec, exp(coef(weightsMixExp)[2]), lower.tail = FALSE)))

colnames(dfw) <- c("t", "15-19", "20-24", "25-29", "30-34", "35-39", "40-44")

# weighted average model results 
dfw$w15 <- as.numeric(rep(p[1,3], length(dfw$t)))
dfw$w20 <- as.numeric(rep(p[2,3], length(dfw$t)))
dfw$w25 <- as.numeric(rep(p[3,3], length(dfw$t)))
dfw$w30 <- as.numeric(rep(p[4,3], length(dfw$t)))
dfw$w35 <- as.numeric(rep(p[5,3], length(dfw$t)))
dfw$w40 <- as.numeric(rep(p[6,3], length(dfw$t)))

avg_w <- dfw$`15-19`*dfw$w15 + dfw$`20-24`*dfw$w20 + dfw$`25-29`*dfw$w25 + 
       dfw$`30-34`*dfw$w30 + dfw$`35-39`*dfw$w35 + dfw$`40-44`*dfw$w40

# compare avg to survival 
dfw2 <- as.data.frame(cbind(1:364, km$surv, avg, avg_w))

colnames(dfw2) <- c("t", "KM", "MixedExpAvg", "WeightsMixExp")

plot_ly(dfw2, x = ~t, y = ~KM, mode = 'lines', name = "K-M, unweighted", type='scatter') %>%
  add_trace(y = ~MixedExpAvg, mode='lines', name="Mixed Exp Avg") %>%
  add_trace(y = ~WeightsMixExp, mode = 'lines', name = "Weights Mix Exp Avg") %>%
  layout(title="K-M versus Weighted Average of Mixed Exp Models (no survey weights)",
         yaxis = list(title="S(t)"), 
         xaxis= list("t, months"))

```


### Covariate Models

note: categorical models not shown here! finding a way to plot better 

```{r full-dataset, echo=FALSE, warnings=FALSE}
######## load continuous covariate models ##########
exp <- readRDS(here("model_fits", "nocovs", "exp.rds")) 
weib <- readRDS(here("model_fits", "nocovs", "weib.rds")) 

expEgoAgeCurrent <- readRDS(here("model_fits", "age", "expEgoAgeCurrent.rds"))
weibEgoAgeCurrent <- readRDS(here("model_fits", "age", "weibEgoAgeCurrent.rds"))

expEgoAgeInit <- readRDS(here("model_fits", "age", "expEgoAgeInit.rds"))
weibEgoAgeInit <- readRDS(here("model_fits", "age", "weibEgoAgeInit.rds"))

# diff sqrt age
expAgeDiff <- readRDS(here("model_fits", "age", "expAgeDiff.rds"))
weibAgeDiff <- readRDS(here("model_fits", "age", "weibAgeDiff.rds"))

expAgeDiff_CurAge <- readRDS(here("model_fits", "age", "expAgeDiff_CurAge.rds"))
weibAgeDiff_CurAge <- readRDS(here("model_fits", "age", "weibAgeDiff_CurAge.rds"))

##### load categorical covariate models ######
# age cat
expAgeCatCurrent <- readRDS(here("model_fits", "age", "expAgeCatCurrent.rds"))
weibAgeCatCurrent <- readRDS(here("model_fits", "age", "weibAgeCatCurrent.rds"))

expAgeDiffAgeCatCurrent <- readRDS(here("model_fits", "age", "expAgeDiffAgeCatCurrent.rds"))
weibAgeDiffAgeCatCurrent <- readRDS(here("model_fits", "age", "weibAgeDiffAgeCatCurrent.rds"))
```

```{r exp-plots, out.width='50%', echo=FALSE}

#plot non-categorical models, first one by one and then all together

plot(exp, main="Exponential, No Covs",
     ylab="S(t)", xlab="t, months", lwd=3, col="red")
legend(300, 1, legend = c("K-M", "No Covs"), 
       col = c(1, "red"), lwd=3)


plot(expEgoAgeCurrent,
     main="Exponential, Current Ego Age",
     ylab="S(t)", xlab="t, months", lwd=3, col="steelblue3")
legend(300, 1, legend = c("K-M", "Current Ego Age"), 
       col = c(1, "steelblue3"), lwd=3)

plot(expEgoAgeInit,
     main="Exponential, Initial Ego Age",
     ylab="S(t)", xlab="t, months", lwd=3, col="orange")
legend(300, 1, legend = c("K-M", "Initial Ego Age"), 
       col = c(1, "orange"), lwd=3)

plot(expAgeDiff,
     main="Exponential, Age Difference",
     ylab="S(t)", xlab="t, months", lwd=3, col="springgreen3")
legend(300, 1, legend = c("K-M", "Age Difference"), 
       col = c(1, "springgreen3"), lwd=3)
```

```{r exp-plot-full, echo=FALSE}
plot(exp,
     main="Basic Age Dynamics, Exp Dist",
     ylab="S(t)", xlab="t, months", lwd=3)
lines(expAgeDiff, col="forestgreen")
lines(expEgoAgeInit, col="orange", lwd=3)
lines(expEgoAgeCurrent, col="steelblue3", lwd=3)
legend(300, 1, legend = c("K-M", "No Covs", "AgeDiff", "Initial Ego Age", "Current Ego Age"), 
       col = c(1, "red", "springgreen3", "orange", "steelblue3"), lwd=3)

plot(expAgeCatCurrent, main="Exponential, Current Ego Age Category")
plot(weibAgeCatCurrent, main="Weibull, Current Ego Age Category")
```

```{r weib-plots, echo=FALSE, out.width='50%'}
plot(weib, main="Weibull, No Covs", ylab="S(t)", xlab="t, months", lwd=3, col="red")
legend(300, 1, legend=c("KM", "No Covs"), col = c(1, "red"), lwd=3)

plot(weibAgeDiff, main="Weibull, Age Diff", ylab="S(t)", xlab="t, months", lwd=3, col="springgreen3")
legend(300, 1, legend=c("KM", "Age Diff"), col = c(1, "springgreen3"), lwd=3)

plot(weibEgoAgeInit, main="Weibull, Initial Ego Age", ylab="S(t)", xlab="t, months", lwd=3, col="orange")
legend(300, 1, legend=c("KM", "Initial Ego Age"), col = c(1, "orange"), lwd=3)

plot(weibEgoAgeCurrent, main="Weibull, Current Ego Age", ylab="S(t)", xlab="t, months", lwd=3, col="steelblue3")
legend(300, 1, legend=c("KM", "Current Ego Age"), col = c(1, "steelblue3"), lwd=3)
```

```{r weib-plot-full, echo=FALSE}
plot(weib,
     main="Basic Age Dynamics, Weibull Dist",
     ylab="S(t)", xlab="t, months", lwd=3)
lines(weibAgeDiff, col="springgreen3")
lines(weibEgoAgeInit, col="orange", lwd=3)
lines(weibEgoAgeCurrent, col="steelblue3", lwd=3)
legend(300, 1, legend = c("K-M", "No Covs", "AgeDiff", "Initial Ego Age", "Current Ego Age"), 
       col = c(1, "red", "springgreen3", "orange", "steelblue3"), lwd=3)

```


## Thoughts & Discussions 

 - age is not responsible for the initial steep drop-off
 - exp mixture models & weibulls fit better because there is failty endogenous to the relationships 
 - weibull isn't masking the effect of age
 - has anybody demonstrated a crosswalk between a exponential mixture and a weibull? 
 - theory: why doesn't age have a larger effect?
 - age / period / cohort effects - what would we expect? 
 - review length bias in survival analysis / study design issues
 
